# 操作说明



## 一、环境部署

### 1. UE4 插件安装

- Enhanced Vehicle Movement
- TCP Socket Plugin
- JSON Blueprint support
- Missile M26 (West)

### 2. UE4 文件拷贝
> 将 `5_工程项目\mul_control_v0.3.2\Content\ `下的 `VigilanteContent、MYmoxing`、`Deaths`、、`Missle_related`、`Meshes`、`Modular_soldier_01`、`ThirdPersonBP`、`USParatrooper`、`Mannequin`、`Game_BP`、`start.uasset`、`TcpSocket_exp.uasset` 、`TcpSocket_exp2.uasset` 、`TcpSocket_exp3.uasset` 、`TcpSocket_exp4.uasset` 到`自己的工程\Content\`下，注意不要覆盖自己已有的重要文件，其实 `mul_control_v0.3.2` 本身就是一个支持 AirSim 的实验测试工程。

### 3. Python 安装包
> 进入相应的 Python 虚拟环境，安装 Python 包

```powershell
pip install numpy flask flask_cors gevent joblib loguru pymap3 folium pandas
```



## 二、UE4 操作准备

### 1. 启动 UE 工程

> 打开启动自己的 UE4 工程，支持 AirSim 模式。

### 2. 开启初始通讯

> 打开自己的 UE4 工程，在内容浏览器里，将 `Content\` 下的 `start` 拖入视窗场景中的任意位置即可。例如`start` 蓝图包含了初始化坦克编号、名称、通讯方式、获取原点坐标等操作，坦克 `ip` 的 `port` 从 20000 开始根据对应的 `id` 自动分配端口，例如 `id` 为 0 的坦克的端口是 20000，`id` 为 1 的坦克的端口是 20001，而当前 `ip` 默认是本机 IP，即 127.0.0.1。而导弹的端口从30000开始，士兵的端口从40000开始，特朗普等换脸角色从50000开始。

### 3. 创建坦克群

> 在内容浏览器里，先在 `放置actor` 中搜索添加一个 `NavMeshBoundsVolume` 到视窗，把它放大到包含所有可以到达的地方就可以了。然后，进入 `Content\VigilanteContent\Vehicles\West_Tank_M1A1Abrams\`，拖动 `TK_AI` 蓝图进入视窗场景中，调整坦克位置即可，需要多个坦克，可以重复拖动 `TK_AI` 蓝图进入视窗场景，例如第一次拖动 `TK_AI`，生成名称为 `TK_AI` 的坦克，第二次则生成名为 `TK_AI2` 的坦克。`TK_AI` 蓝图包含了坦克数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 4. 创建导弹群

> 在内容浏览器里，进入 `\Content\Missle_related\`，拖动 `MIS_AI` 蓝图进入视窗场景中，调整导弹位置，可直立住即可，需要多个导弹，可以重复拖动 `MIS_AI` 蓝图进入视窗场景，例如第一次拖动 `MIS_AI`，生成名称为 `MIS_AI` 的导弹，第二次则生成名为 `MIS_AI2` 的导弹。 `MIS_AI` 蓝图包含了导弹数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 5. 创建士兵群

> 在内容浏览器里，进入 `\Content\Modular_soldier_01\新角色_士兵\`，拖动 `SOL_AI` 蓝图进入视窗场景中即可，可以重复拖动 `SOL_AI` 蓝图进入视窗场景，例如第一次拖动 `SOL_AI`，生成名称为 `SOL_AI` 的士兵，第二次则生成名为 `SOL_AI2` 的士兵。 `SOL_AI` 蓝图包含了士兵数据存储与运动控制模块，同时也包含了单体TCP通讯模块。

### 6. 创建特朗普

> 在内容浏览器里，进入 `\Content\Modular_soldier_01\新角色_士兵\chuanp\`，拖动 `TP_AI` 蓝图进入视窗场景中即可，可以重复拖动 `TP_AI` 蓝图进入视窗场景，例如第一次拖动 `TP_AI`，生成名称为 `TP_AI` 的特朗普。 `TP_AI` 蓝图包含了特朗普数据存储与运动控制模块，同时也包含了单体TCP通讯模块。



## 三、python 操作

### 1. 进入程序根目录 
```powershell
cd MCI_v0.3.2
```

### 2. 创建数据库文件

```power
python 1_create_db.py
```

### 3. 运行多体控制接口程序

```powershell
python 2_UE_Main_API.py
```

### 4. 运行测试程序
```powershell
python 3_send_test_tank.py # 坦克控制测试案例 
python 3_send_test_missile.py # 导弹控制测试案例
python 3_send_test_solider.py # 士兵控制测试案例
python 3_send_test_trump.py # 特朗普控制测试案例
```

### 5. 运行 UE4 工程

> 点击 UE4 运行按钮，运行 AirSim 环境

### 6. 读取 SQLite 数据库数据

```powershell
python 4_read_sqlite.py # 此为参考例子，需提前修改要读取的数据库与相关数据内容
```



## *、其它说明

> 1. 根目录下的 info_dict.pkl 文件是接口服务生成的临时文件，不需要关注
> 2. 根目录下的 \*\_init.db 是初始化数据库文件、\*\_record.db 是用于数据实时记录的数据库文件
> 3. 根目录下的 runtime.log 是接口服务运行过程中生成的日志文件，方便查看程序运行的错误日志
> 4. 根目录下的 geo_change.py 是各种坐标或坐标系转换的函数库文件，也包括高德导航路径规划算法
> 5. 根目录下的 TCPROCKET.py 是实现 TCP Rocket 通讯的核心文件，一般被 2_UE_Main_API.py 调用
> 6. 根目录下的 before\_\* 文件夹是每次新建数据库后，把之前的数据库都保存在该文件夹中，`*` 对应移动文件的时间点，总名称格式为`'before_%Y_%m_%d_%H_%M_%S'`，也就是表明文件夹中的数据库文件是在该时间点之前移动进文件夹的  